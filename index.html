<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Deriv PUT/CALL Advanced Strategy Bot</title>
  <style>
    body { font-family: Arial, sans-serif; background:#111; color:#eee; }
    .panel { background:#222; padding:15px; margin:10px; border-radius:8px; }
    button { padding:8px 12px; border:none; border-radius:6px; margin:4px; cursor:pointer; }
    .start { background:green; color:#fff; }
    .stop { background:red; color:#fff; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    td,th { border:1px solid #444; padding:4px; text-align:center; }
  </style>
</head>
<body>
  <h2>Deriv PUT/CALL Advanced Strategy Bot</h2>
  
  <div class="panel">
    <label>Token: <input id="token" type="password" size="50"></label><br>
    <label>App ID: <input id="app_id" value="1089"></label><br>
    <label>Symbol: 
      <select id="symbol">
        <option value="R_100">R_100</option>
        <option value="R_75">R_75</option>
        <option value="R_50">R_50</option>
      </select>
    </label><br>
    <label>Stake: <input id="stake" type="number" value="1"></label>
    <label>Duration (ticks): <input id="duration" type="number" value="5"></label><br>
    <label>Take Profit: <input id="tp" type="number" value="20"></label>
    <label>Stop Loss: <input id="sl" type="number" value="20"></label><br>
    <label>Cooldown (sec): <input id="cooldown" type="number" value="10"></label><br>
    <label>Strategy:
      <select id="strategy">
        <option value="trend2">Trend2</option>
        <option value="ema">EMA Cross</option>
        <option value="rsi">RSI Momentum</option>
        <option value="hybrid">Hybrid (2 of 3 confirm)</option>
      </select>
    </label><br>
    <button class="start" onclick="startBot()">Start</button>
    <button class="stop" onclick="stopBot()">Stop</button>
  </div>
  
  <div class="panel">
    <h3>Status</h3>
    <div id="status">Idle</div>
    <div>P/L: <span id="pl">0</span> | Wins: <span id="wins">0</span> | Losses: <span id="losses">0</span></div>
    <table id="log">
      <tr><th>#</th><th>Contract</th><th>Result</th><th>Profit</th></tr>
    </table>
  </div>
  
<script>
let ws, isRunning = false, authorized = false;
let stake, duration, tp, sl, cooldown, strategy, symbol;
let profit = 0, wins = 0, losses = 0, tradeCount = 0;
let lastTick = null, prevTick = null, lastTradeTime = 0;
let emaFast = null, emaSlow = null, rsiArr = [];

function startBot(){
  if(isRunning) return;
  const token = document.getElementById("token").value.trim();
  const app_id = document.getElementById("app_id").value.trim();
  if(!token){ alert("Enter token"); return; }
  
  stake = +document.getElementById("stake").value;
  duration = +document.getElementById("duration").value;
  tp = +document.getElementById("tp").value;
  sl = +document.getElementById("sl").value;
  cooldown = +document.getElementById("cooldown").value * 1000;
  strategy = document.getElementById("strategy").value;
  symbol = document.getElementById("symbol").value;
  
  ws = new WebSocket(`wss://ws.derivws.com/websockets/v3?app_id=${app_id}`);
  ws.onopen = () => ws.send(JSON.stringify({authorize: token}));
  ws.onmessage = onMsg;
  isRunning = true;
  document.getElementById("status").innerText = "Starting...";
}

function stopBot(){
  isRunning = false;
  if(ws) ws.close();
  document.getElementById("status").innerText = "Stopped";
}

function onMsg(msg){
  const data = JSON.parse(msg.data);

  if(data.msg_type === "authorize"){ 
    authorized = true;
    document.getElementById("status").innerText = "Authorized, subscribing to ticks...";
    ws.send(JSON.stringify({ticks: symbol, subscribe:1}));
  }
  
  if(data.msg_type === "tick"){
    prevTick = lastTick;
    lastTick = data.tick.quote;
    handleStrategy();
  }
  
  if(data.msg_type === "proposal_open_contract"){
    let poc = data.proposal_open_contract;
    if(poc.is_sold){
      tradeCount++;
      if(poc.profit > 0){ wins++; profit += poc.profit; logTrade(poc.contract_id,"WIN",poc.profit); }
      else { losses++; profit += poc.profit; logTrade(poc.contract_id,"LOSS",poc.profit); }
      updateStats();
      checkStop();
    }
  }
}

function handleStrategy(){
  if(!prevTick) return;
  let now = Date.now();
  if(now - lastTradeTime < cooldown) return;
  
  let signal = null;
  
  if(strategy==="trend2"){
    if(lastTick>prevTick && prevTick > (rsiArr.length? rsiArr[rsiArr.length-1]:prevTick)) signal="CALL";
    if(lastTick<prevTick && prevTick < (rsiArr.length? rsiArr[rsiArr.length-1]:prevTick)) signal="PUT";
  }
  
  if(strategy==="ema" || strategy==="hybrid"){
    if(emaFast && emaSlow){
      if(emaFast>emaSlow) signal="CALL";
      else signal="PUT";
    }
  }
  
  if(strategy==="rsi" || strategy==="hybrid"){
    if(rsiArr.length>=14){
      let rsi = calcRSI(rsiArr,14);
      if(rsi>55) signal="CALL";
      else if(rsi<45) signal="PUT";
    }
  }
  
  if(strategy==="hybrid"){
    // combine signals
    let votes = [];
    if(emaFast && emaSlow) votes.push(emaFast>emaSlow?"CALL":"PUT");
    if(rsiArr.length>=14){
      let rsi = calcRSI(rsiArr,14);
      if(rsi>55) votes.push("CALL");
      else if(rsi<45) votes.push("PUT");
    }
    if(lastTick>prevTick) votes.push("CALL"); else if(lastTick<prevTick) votes.push("PUT");
    let calls=votes.filter(v=>v==="CALL").length;
    let puts=votes.filter(v=>v==="PUT").length;
    signal = calls>=2?"CALL":(puts>=2?"PUT":null);
  }
  
  rsiArr.push(lastTick);
  if(rsiArr.length>100) rsiArr.shift();
  emaFast = emaCalc(emaFast,lastTick,10);
  emaSlow = emaCalc(emaSlow,lastTick,20);
  
  if(signal){ placeTrade(signal); lastTradeTime = now; }
}

function placeTrade(type){
  if(!authorized) return;
  document.getElementById("status").innerText = "Proposing "+type;
  ws.send(JSON.stringify({
    proposal:1, amount:stake, basis:"stake", contract_type:type,
    currency:"USD", duration:duration, duration_unit:"t", symbol:symbol
  }));
  ws.onmessage = (msg)=>{
    const data = JSON.parse(msg.data);
    if(data.msg_type==="proposal"){
      ws.send(JSON.stringify({buy:data.proposal.id, price:stake}));
    }
    if(data.msg_type==="buy"){
      ws.send(JSON.stringify({subscribe:1, proposal_open_contract:data.buy.contract_id}));
    }
    if(data.msg_type==="proposal_open_contract"){
      onMsg(msg);
    }
  };
}

function emaCalc(prev,price,period){
  if(prev===null) return price;
  let k=2/(period+1);
  return price*k+prev*(1-k);
}

function calcRSI(arr, period){
  let gains=0, losses=0;
  for(let i=1;i<=period;i++){
    let diff=arr[arr.length-i]-arr[arr.length-i-1];
    if(diff>=0) gains+=diff; else losses-=diff;
  }
  let rs = gains/(losses||1);
  return 100-100/(1+rs);
}

function updateStats(){
  document.getElementById("pl").innerText = profit.toFixed(2);
  document.getElementById("wins").innerText = wins;
  document.getElementById("losses").innerText = losses;
}

function logTrade(id,res,p){
  let row = document.createElement("tr");
  row.innerHTML = `<td>${tradeCount}</td><td>${id}</td><td>${res}</td><td>${p.toFixed(2)}</td>`;
  document.getElementById("log").appendChild(row);
}

function checkStop(){
  if(tp && profit>=tp){ stopBot(); alert("TP reached"); }
  if(sl && profit<=-sl){ stopBot(); alert("SL reached"); }
}
</script>
</body>
</html>
